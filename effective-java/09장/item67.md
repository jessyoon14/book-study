# 67. 최적화는 신중히 하라

빠른 프로그램보다는 좋은 프로그램을 작성하라

- 좋은 프로그램을 작성하면 성능은 따라온다
- 섣부른 최적화가 만악의 근원이다
- 성능을 위해 견고한 구조를 희생하지 말라
    - 책임이 잘 분리되면 각 부분을 개별적으로 최적화 할 수 있다
    - 안좋은 구조로 인한 성능 저하는 시스템 전체를 뜯어고쳐야 한다

성능을 염두에 둔 설계

- 성능을 제한하는 설계를 피하라
    - 특히, 완성 후 변경하기 어려운 요소는 조심해서 설계할 것
        - 컴포넌트간/외부와의 소통 방식 (API, 네트워크 프로토콜, 영구 저장용 데이터 포맷)
- API를 설계할 때는 성능에 주는 영향을 고려하라
    - 추천 패턴
        - 방어적 복사를 줄이기 위해 public 타입은 불변으로 만들기
        - 컴포지션으로 구현할 수 있는데 상속으로 설계한 클래스는 성능제약을 물려받는다
        - 구현체보다는 인터페이스를 사용하기
    - 성능을 위해 APi를 왜곡하지 말라
        - API를 왜곡하게 만든 성능 문제는 미래에 없어질 수 있지만, 왜곡된 API는 영원히 고통을 유발한다

### 각 최적화 시도 전후로 성능을 측정하라

- 시도한 최적화 기법이 성능을 떨어뜨리거나 유지할 때도 많다
- profiling tool을 사용해서 어디를 최적화할지 파악해야 한다
    - 개별 메소드의 소비 시간, 호출 횟수 알려줌
    - 알고리즘을 잘못 고르면 다른 최적화가 의미가 없다
    - 비슷한 도구: jmh (마이크로 벤치마킹 프레임 워크, 자바 코드의 상세한 성능 분석)
- 자바는 작성하는 코드와 CPU에서 수행하는 명령 사이의 격차가 커서 최적화로 인한 성능 변화를 에측하기가 어렵다
- 성능이 시스템, 릴리스, 프로세서별로 다르므로 각 플랫폼마다 최적화 효과를 측정해야 한다